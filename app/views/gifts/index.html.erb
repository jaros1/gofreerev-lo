<%= hidden_field_tag :newest_gift_id, @newest_gift_id, :id => "newest-gift-id" %>
<%= hidden_field_tag :newest_status_update_at, @newest_status_update_at, :id => "newest-status-update-at" %>

<script>
    last_user_ajax_comment_at = null;
    <%=
      # recheck invalid picture urls with owner permissions
      @missing_api_picture_urls
    %>

</script>


<script>
</script>



<a href="#" id="share_gift" style="display: none">share gift</a>


<%# create new gift form -%>
<div style="width: 100%"><%= t '.create_gift_header_line' %></div>
<div style="width: 100%">
  <%= form_for @gift, :html => {:enctype => 'multipart/form-data', :id => 'new_gift'}, :data => { :type => :script }, :format => :js do |f| -%>
      <table>
        <tr title="<%= t '.price_title', :min_interest => NEG_INT_POS_BALANCE_PER_YEAR, :max_interest => NEG_INT_NEG_BALANCE_PER_YEAR %>">
          <td><%= t '.price_prompt' %></td>
          <td>
            <%= f.text_field(:price, :size => 10, :maxlength => 10, :placeholder => t('.price_placeholder')) %>
            <%= t '.price_free' %>
            <%= @users.first.currency %>
            &nbsp;&nbsp;&nbsp;
            <div style="text-wrap: none">
              <%= t '.direction_giver_prompt' %> <%= f.radio_button :direction, 'giver' %>&nbsp;&nbsp;
              <%= t '.direction_receiver_prompt' %> <%= f.radio_button :direction, 'receiver' %>
            </div>
          </td>
        </tr>
        <tr title="<%= t '.description_title' %>">
          <td style="vertical-align: top"><%= t '.description_prompt' %></td>
          <td><%= f.text_area :description, :size => '60x2', :placeholder => t('.description_placeholder'), :onfocus => 'autoresize_text_field(this)', :class => 'new_gift_text' %>
            <%= f.submit t('.gift_submit_button_text'), :onclick => '{return csv_gift()}', :name => 'commit_gift', :class => 'new_gift_submit_large' %></td>
        </tr>
        <tr title="<%= t ".file_title_#{post_image_allowed?()}", :appname => APP_NAME %>">
          <td>
            <div class="fileupload bottom">
              <%= t '.file_prompt' %>
              <%= file_field_tag :gift_file, :disabled => !post_image_allowed?(), :id => "gift_file", :class => "upload", :accept => "image/*;capture=camera",
                                 :onchange => '{document.getElementById("disp_gift_file").value = this.value}' %>
            </div>
          </td>
          <td>
            <table>
              <tbody>
              <tr>
                <td><%= text_field_tag '', '', :id => "disp_gift_file", :placeholder => t('.file_placeholder'), :disabled => "disabled", :style => "line-height:16px;" %></td>
                <td>
                  <table class="new_gift_link_large">
                    <tbody>
                    <tr>
                      <td><%= t '.link_prompt' %></td>
                      <td><%= f.text_field(:open_graph_url, :size => 28, :maxlength => 200, :placeholder => t('.link_placeholder'), :id => "gift_open_graph_url1", :class => 'gift_open_graph_url', :oninput=>"gift_open_graph_url_sync(this)") %></td>
                    </tr>
                    </tbody>
                  </table>
                </td>
              </tr>
              </tbody>
            </table>
          </td>
        </tr>
        <tr class="new_gift_link_small">
          <td><%= t '.link_prompt' %></td>
          <td><%= f.text_field(:open_graph_url, :size => 28, :maxlength => 200, :placeholder => t('.link_placeholder'), :id => "gift_open_graph_url2", :class => 'gift_open_graph_url', :oninput=>"gift_open_graph_url_sync(this)") %></td>
        </tr>
        <tr>
          <td id="open_graph_url_preview" colspan="2"></td>
        </tr>
        <tr>
          <td colspan="2">
            <div id="files" class="files"></div>
          </td>
        </tr>
        <tr class="new_gift_submit_small">
          <td></td>
          <td><%= f.submit t('.gift_submit_button_text'), :onclick => '{return csv_gift()}', :name => 'commit_gift' %></td>
        </tr>
      </table>
  <% end # form   -%>
</div>
<%# Modernizr.progressbar is required -%>
<div class="demo-wrapper html5-progress-bar" id="progressbar-div" style="display: none">
  <div class="progress-bar-wrapper">
    <progress id="progressbar" value="0" max="100"></progress>
    <span class="progress-value">0%</span>
  </div>
</div>
<div style="width: 100%">
  <hr>
</div>

<%# special messages to new users how to get started -%>
<% if @api_gifts.size == 0
     hr = true
-%>
    <div id="no-gifts-div" style="width: 100%">
      <%= t '.no_gifts_was_found_html', :appname => APP_NAME %>
    </div>
<% end -%>
<% if User.no_app_friends(@users) == 0 -%>
    <%= hr = true ; render :partial => 'shared/no_app_friends' %>
<% end -%>
<% if hr -%>
    <div style="width: 100%">
      <hr>
    </div>
<% end -%>

<%# gifts table -%>
<div style="width: 100%">
  <table  id="gifts" style="table-layout:fixed; <%= 'display: none; ' if @api_gifts.size == 0  %>">
    <thead>
    <%= render :partial => 'table_header_row' %>
    </thead>
    <tbody id="gifts_tbody">
    <%= render :partial => 'api_gifts' %>
    </tbody>
    <tfoot>
    <tr id="show-more-rows-spinner">
      <td colspan="4">
        <img src="/images/ajax-loading-64.gif"/>
      </td>
    </tr>
    <tr>
      <td colspan="4">
        <table>
          <tbody id='show-more-rows-errors' class="ajax_errors">
          </tbody>
        </table>
      </td>
    </tr>
    </tfoot>
  </table>
</div>
<br/>

<%# add remote link to get more rows and call javascript to setup end of page event and post ajax handling of the new rows. set DEBUG_AJAX to true in initializers/constraints.rb to get more ajax debug information -%>
<%= link_to "show-more-rows", "/gifts?last_row_id=#{@last_row_id}",
            :remote => true, :data => { :type => :script }, :format => :js,
            :id => "show-more-rows-link", :style => "display: none" %>
<%= render :partial => 'shared/show_more_rows', :locals => {:show_more_rows => 'gifts'} %>

<script>
    // add page specific version of pre_update_currency function.
    // That is confirm popup before leaving page with unsaved data.
    pending_gift_msg = '<%= t '.pending_gift_popup_msg' %>';
    pre_update_currency = gifts_pre_update_currency;
</script>

<script>
  // new gift. check for /gifts?url=..&text==.. share link
  // ajax get open graph meta tags in 2 seconds and display open graph preview under link
  (function () {
      var url = document.getElementById('gift_open_graph_url1') ;
      if (url.value) gift_open_graph_url_sync(url) ;
  })();
</script>

<!--
  image upload with drag and drop support.
  from https://blueimp.github.io/jQuery-File-Upload/
-->

<!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>-->
<!--<script src="/assets/jquery.js?body=1"></script>-->
<!--<script src="/assets/jquery.ui.effect.js?body=1"></script>-->
<!--<script src="/assets/jquery_ujs.js?body=1"></script>-->
<!--<script src="/assets/jquery-ui.js?body=1"></script>-->
<!--<script src="/assets/jquery.cookie.js?body=1"></script>-->
<!--<script src="/assets/jquery.form.js?body=1"></script>-->

<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
<!--<script src="js/vendor/jquery.ui.widget.js"></script>-->

<!-- The Load Image plugin is included for the preview images and image resizing functionality -->
<!--<script src="//blueimp.github.io/JavaScript-Load-Image/js/load-image.all.min.js"></script>-->
<script src="/assets/load-image.js"></script>
<script src="/assets/load-image-ios.js"></script>
<script src="/assets/load-image-orientation.js"></script>
<script src="/assets/load-image-meta.js"></script>
<script src="/assets/load-image-exif.js"></script>
<script src="/assets/load-image-exif-map.js"></script>

<!-- The Canvas to Blob plugin is included for image resizing functionality -->
<!--<script src="//blueimp.github.io/JavaScript-Canvas-to-Blob/js/canvas-to-blob.min.js"></script>-->
<script src="/assets/canvas-to-blob.js"></script>

<!-- Bootstrap JS is not required, but included for the responsive demo navigation -->
<!--<script src="//netdna.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-transition.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-alert.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-modal.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-dropdown.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-scrollspy.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-tab.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-tooltip.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-popover.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-button.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-collapse.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-carousel.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-typeahead.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap/bootstrap-affix.js?body=1"></script>-->
<!--<script src="/assets/twitter/bootstrap.js?body=1"></script>-->
<!--<script src="/assets/bootstrap.js?body=1"></script>-->

<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<script src="/assets/jquery.iframe-transport.js"></script>
<!-- The basic File Upload plugin -->
<script src="/assets/jquery.fileupload.js"></script>
<!-- The File Upload processing plugin -->
<script src="/assets/jquery.fileupload-process.js"></script>
<!-- The File Upload image preview & resize plugin -->
<script src="/assets/jquery.fileupload-image.js"></script>
<!-- The File Upload audio preview plugin -->
<!--<script src="js/jquery.fileupload-audio.js"></script>-->
<!-- The File Upload video preview plugin -->
<!--<script src="js/jquery.fileupload-video.js"></script>-->
<!-- The File Upload validation plugin -->
<script src="/assets/jquery.fileupload-validate.js"></script>
<script>
    /*jslint unparam: true, regexp: true */
    /*global window, $ */
    $(function () {
        'use strict';
        // Change this url to the location of your server-side upload handler:
        var url = '/util/upload/',
                uploadButton = $('<button/>')
                        .addClass('btn btn-primary')
                        .prop('disabled', true)
                        .text('Processing...')
                        .on('click', function () {
                            var $this = $(this),
                                    data = $this.data();
                            $this
                                    .off('click')
                                    .text('Abort')
                                    .on('click', function () {
                                        $this.remove();
                                        data.abort();
                                    });
                            data.submit().always(function () {
                                $this.remove();
                            });
                        });
        $('#gift_file').fileupload({
            url: url,
            dataType: 'json',
            autoUpload: false,
            acceptFileTypes: /(\.|\/)(gif|jpe?g|png|bmp)$/i,
            maxFileSize: 5000000, // 5 MB
            // Enable image resizing, except for Android and Opera,
            // which actually support image resizing, but fail to
            // send Blob objects via XHR requests:
            disableImageResize: /Android(?!.*Chrome)|Opera/
                    .test(window.navigator.userAgent),
            previewMaxWidth: 100,
            previewMaxHeight: 100,
            previewCrop: true
        }).on('fileuploadadd', function (e, data) {
            var filetype = data.originalFiles[0].type ;
            if (!/^image\/(gif|jpe?g|png|bmp)$/.test(filetype)) return $.last(); // invalid filetype
            $('#files').empty(); // keep only last image
            data.context = $('<div/>').appendTo('#files');
            $.each(data.files, function (index, file) {
                var node = $('<p/>')
                        .append($('<span/>').text(file.name));
                if (!index) {
                    node
                            .append('<br>')
                            .append(uploadButton.clone(true).data(data));
                }
                node.appendTo(data.context);
            });
        }).on('fileuploadprocessalways', function (e, data) {
            var index = data.index,
                    file = data.files[index],
                    node = $(data.context.children()[index]);
            if (file.preview) {
                node
                        .prepend('<br>')
                        .prepend(file.preview);
            }
            if (file.error) {
                node
                        .append('<br>')
                        .append($('<span class="text-danger"/>').text(file.error));
            }
            if (index + 1 === data.files.length) {
                data.context.find('button')
                        .text('Upload')
                        .prop('disabled', !!data.files.error);
            }
        }).on('fileuploadprogressall', function (e, data) {
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress .progress-bar').css(
                    'width',
                    progress + '%'
            );
        }).on('fileuploaddone', function (e, data) {
            $.each(data.result.files, function (index, file) {
                if (file.url) {
                    var link = $('<a>')
                            .attr('target', '_blank')
                            .prop('href', file.url);
                    $(data.context.children()[index])
                            .wrap(link);
                } else if (file.error) {
                    var error = $('<span class="text-danger"/>').text(file.error);
                    $(data.context.children()[index])
                            .append('<br>')
                            .append(error);
                }
            });
        }).on('fileuploadfail', function (e, data) {
            $.each(data.files, function (index) {
                var error = $('<span class="text-danger"/>').text('File upload failed.');
                $(data.context.children()[index])
                        .append('<br>')
                        .append(error);
            });
        }).prop('disabled', !$.support.fileInput)
                .parent().addClass($.support.fileInput ? undefined : 'disabled');
    });
</script>






