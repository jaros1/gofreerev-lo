testrun 41 - ok testrun with request_comments => send_gifts
one new comment from client 1 on app 1 to client 2 on app 2

client 1:
- receive check_gifts message from client 2 - returns send_gifts message to client 2 - mid 14339482644601033312
GiftService.receive_message_check_gifts: mailbox  = {"did":"14322883971308289539","sha256":"t5HP7V58Ta6LW7R98LtpLkYgjzveJswACYZnqERap0k=","mutual_friends":[2,3],"server_id":1,"key":"14322883971308289539t5HP7V58Ta6LW7R98LtpLkYgjzveJswACYZnqERap0k=","online":true,"inbox":[{"mid":"14339482604127316574","msgtype":"request_comments","comments":["14339226827756085437"],"request_mid":"14339482558087655839","users":[2]}],"read":[],"outbox":[],"sending":[],"sent":[],"done":[{"msgtype":"users_sha256","mid":"14339482324570677293","users":[{"user_id":"5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U=","sha256":"\u000fÚÌEÓñtÍé¬ì\u0017ÙNTìj\u0013Â÷Ô!´öå\u001a"},{"user_id":"7WOPKvINGnO9oTSgNRJauP7dJZFVxktEnG+EmlY9Xys="}]},{"mid":"14339482471556141728","request_mid":"14339482262471399939","msgtype":"gifts_sha256","ignore_invalid_gifts":[],"users":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"gifts":[{"gid":"14335999822639189665","sha256":"mQ©4\u0006\u0019¤Öó¥$\u001d.×\u001c¢Süä|Û\u0014\fõ"}]},{"mid":"14339482557708457395","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"mQ©4\u0006\u0019¤Öó¥$\u001d.×\u001c¢Süä|Û\u0014\fõ","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"w&|ðÈ\u0002i\u000füÛ«:ÈhÕãé+ÞæD\u0017P79^\u0013®ï\t"}]},{"mid":"14339482558087655839","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"mQ©4\u0006\u0019¤Öó¥$\u001d.×\u001c¢Süä|Û\u0014\fõ","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"w&|ðÈ\u0002i\u000füÛ«:ÈhÕãé+ÞæD\u0017P79^\u0013®ï\t","comments":[{"cid":"14336000949698090073","sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"},{"cid":"14339226827756085437","sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ"}]}]}],"error":[]}
GiftService.receive_message_check_gifts: msg      = {"mid":"14339482603960257166","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:","comments":[{"cid":"14336000949698090073","sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"}]}],"request_mid":"14339482557708457395","users":[2]}
GiftService.receive_message_check_gifts: msg_gift.comments.length = 1
GiftService.receive_message_check_gifts: msg_gift.comments = [{"cid":"14336000949698090073","sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"}]
GiftService.receive_message_check_gifts: my_gift.comments.length = 2
GiftService.receive_message_check_gifts: my_gift.comments = [{"cid":"14336000949698090073","user_ids":[3],"comment":"client 2 => client 1","currency":"usd","created_at_client":1433600094,"created_at_server":1,"sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"},{"cid":"14339226827756085437","user_ids":[2],"comment":"client 1 => client 2","currency":"usd","created_at_client":1433922682,"created_at_server":0,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ"}]
GiftService.receive_message_check_gifts: invalid_gids =
GiftService.receive_message_check_gifts: merge_gifts = {"14335999822639189665":{"msg_sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","my_sha256":"mQ©4\u0006\u0019¤Öó¥$\u001d.×\u001c¢Süä|Û\u0014\fõ","msg_sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","my_sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","msg_sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:","my_sha256_comments":"w&|ðÈ\u0002i\u000füÛ«:ÈhÕãé+ÞæD\u0017P79^\u0013®ï\t","identical_gift":true,"identical_comments":false,"comments":{"14336000949698090073":{"msg_sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn","my_sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"},"14339226827756085437":{"my_sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ"}}}}
GiftService.receive_message_check_gifts: return_check_gifts_message = false
GiftService.receive_message_check_gifts: gid = 14335999822639189665, send_gift = true
GiftService.receive_message_check_gifts: cid = 14336000949698090073, send_comment = false, request_comment = false
GiftService.receive_message_check_gifts: cid = 14339226827756085437, send_comment = true, request_comment = false
GiftService.invalid_gift: new_users_index = {}
GiftService.invalid_comment: new_users_index = {}
GiftService.receive_message_check_gifts: send_gifts_sub_message = {"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[2],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[2],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[]}
GiftService.receive_message_check_gifts: request_comments_sub_message = null
GiftService.receive_message_check_gifts: sync_gifts_message (1) = {"mid":"14339482644671925039","request_mid":"14339482603960257166","msgtype":"sync_gifts","users":[2],"send_gifts":{"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[2],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[2],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[]},"request_comments":null}
UserService.user_ids_to_remote_sha256: mutual_friends = [2], typeof user_ids = object
UserService.user_ids_to_remote_sha256: gift.giver_user_ids = [2], typeof user_ids = object
UserService.user_ids_to_remote_sha256: gift.receiver_user_ids = [], typeof user_ids = object
UserService.user_ids_to_remote_sha256: comment.user_ids = [2], typeof user_ids = object
UserService.user_ids_to_remote_sha256: mutual_friends = [], typeof user_ids = object
GiftService.receive_message_check_gifts: sync_gifts_message (2) = {"mid":"14339482644671925039","request_mid":"14339482603960257166","msgtype":"sync_gifts","users":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"send_gifts":{"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[]},"request_comments":null}
GiftService.receive_message_check_gifts: sync_gifts_message (3) = {"mid":"14339482644671925039","request_mid":"14339482603960257166","msgtype":"sync_gifts","users":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"send_gifts":{"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}]},"request_comments":null}
GiftService.validate_send_gifts_message: validating send_gifts message before send
UserService.user_ids_to_remote_sha256: mutual_friends = [2,3], typeof user_ids = object
GiftService.validate_send_gifts_message: mutual_friends = ["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U=","7WOPKvINGnO9oTSgNRJauP7dJZFVxktEnG+EmlY9Xys="]
GiftService.validate_send_gifts_message: send_gifts_received_user_ids  =
GiftService.validate_send_gifts_message: send_gifts_expected_user_ids  =
GiftService.validate_send_gifts_message: send_gift_missing_user_ids    =
GiftService.validate_send_gifts_message: send_gift_unexpected_user_ids =

client 1:
- receive request_comments message from client 2 - return send_gifts message to client 2 - mid 14339482644876083500
GiftService.receive_message_request_comms: mailbox  = {"did":"14322883971308289539","sha256":"t5HP7V58Ta6LW7R98LtpLkYgjzveJswACYZnqERap0k=","mutual_friends":[2,3],"server_id":1,"key":"14322883971308289539t5HP7V58Ta6LW7R98LtpLkYgjzveJswACYZnqERap0k=","online":true,"inbox":[],"read":[],"outbox":[{"mid":"14339482644671925039","request_mid":"14339482603960257166","msgtype":"sync_gifts","users":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"send_gifts":{"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}]}}],"sending":[],"sent":[],"done":[{"msgtype":"users_sha256","mid":"14339482324570677293","users":[{"user_id":"5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U=","sha256":"\u000fÚÌEÓñtÍé¬ì\u0017ÙNTìj\u0013Â÷Ô!´öå\u001a"},{"user_id":"7WOPKvINGnO9oTSgNRJauP7dJZFVxktEnG+EmlY9Xys="}]},{"mid":"14339482471556141728","request_mid":"14339482262471399939","msgtype":"gifts_sha256","ignore_invalid_gifts":[],"users":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"gifts":[{"gid":"14335999822639189665","sha256":"mQ©4\u0006\u0019¤Öó¥$\u001d.×\u001c¢Süä|Û\u0014\fõ"}]},{"mid":"14339482557708457395","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"mQ©4\u0006\u0019¤Öó¥$\u001d.×\u001c¢Süä|Û\u0014\fõ","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"w&|ðÈ\u0002i\u000füÛ«:ÈhÕãé+ÞæD\u0017P79^\u0013®ï\t"}]},{"mid":"14339482558087655839","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"mQ©4\u0006\u0019¤Öó¥$\u001d.×\u001c¢Süä|Û\u0014\fõ","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"w&|ðÈ\u0002i\u000füÛ«:ÈhÕãé+ÞæD\u0017P79^\u0013®ï\t","comments":[{"cid":"14336000949698090073","sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"},{"cid":"14339226827756085437","sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ"}]}]}],"error":[]}
GiftService.receive_message_request_comms: msg      = {"mid":"14339482604127316574","msgtype":"request_comments","comments":["14339226827756085437"],"request_mid":"14339482558087655839","users":[2]}
GiftService.invalid_comment: new_users_index = {}
GiftService.invalid_gift: new_users_index = {}
GiftService.receive_message_request_comms: msg.comments            = 14339226827756085437
GiftService.receive_message_request_comms: ok_cids                 = 14339226827756085437
GiftService.receive_message_request_comms: not_mutual_friends_cids =
GiftService.receive_message_request_comms: invalid_gift_cids       =
GiftService.receive_message_request_comms: invalid_comment_cids    =
GiftService.receive_message_request_comms: unknown_cids            =
GiftService.receive_message_request_comms: send_gifts_sub_message  = {"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[2],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[2],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[]}
GiftService.receive_message_request_comms: send_gifts_users        = [2]
GiftService.receive_message_request_comms:
GiftService.receive_message_request_comms: sync_gifts_message (1) = {"mid":"14339482644973763251","request_mid":"14339482604127316574","msgtype":"sync_gifts","users":[2],"send_gifts":{"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[2],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[2],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[]}}
UserService.user_ids_to_remote_sha256: mutual_friends = [2], typeof user_ids = object
UserService.user_ids_to_remote_sha256: gift.giver_user_ids = [2], typeof user_ids = object
UserService.user_ids_to_remote_sha256: gift.receiver_user_ids = [], typeof user_ids = object
UserService.user_ids_to_remote_sha256: comment.user_ids = [2], typeof user_ids = object
UserService.user_ids_to_remote_sha256: send_gifts.users = [], typeof user_ids = object
GiftService.receive_message_request_comms: sync_gifts_message (2) = {"mid":"14339482644973763251","request_mid":"14339482604127316574","msgtype":"sync_gifts","users":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"send_gifts":{"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[]}}
GiftService.receive_message_request_comms: sync_gifts_message (3) = {"mid":"14339482644973763251","request_mid":"14339482604127316574","msgtype":"sync_gifts","users":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"send_gifts":{"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}]}}
GiftService.validate_send_gifts_message: validating send_gifts message before send
UserService.user_ids_to_remote_sha256: mutual_friends = [2,3], typeof user_ids = object
GiftService.validate_send_gifts_message: mutual_friends = ["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U=","7WOPKvINGnO9oTSgNRJauP7dJZFVxktEnG+EmlY9Xys="]
GiftService.validate_send_gifts_message: send_gifts_received_user_ids  =
GiftService.validate_send_gifts_message: send_gifts_expected_user_ids  =
GiftService.validate_send_gifts_message: send_gift_missing_user_ids    =
GiftService.validate_send_gifts_message: send_gift_unexpected_user_ids =
GiftService.send_messages: msg = {"mid":"14339482644671925039","request_mid":"14339482603960257166","msgtype":"sync_gifts","users":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"send_gifts":{"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}]}}
GiftService.send_messages: msg = {"mid":"14339482644973763251","request_mid":"14339482604127316574","msgtype":"sync_gifts","users":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"send_gifts":{"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}]}}
GiftService.send_messages: unencrypted message = {"sent_at_client":1433948267300,"messages":[{"mid":"14339482644671925039","request_mid":"14339482603960257166","msgtype":"sync_gifts","users":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"send_gifts":{"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}]}},{"mid":"14339482644973763251","request_mid":"14339482604127316574","msgtype":"sync_gifts","users":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"send_gifts":{"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}]}}]}

client 2:
- received send_gifts message from client 1 (response to previous check_gifts message) - mid 14339482644601033312
GiftService.receive_message_send_gifts: mailbox  = {"did":"14322883654942814019","sha256":"PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","mutual_friends":[2,3],"server_id":1,"key":"14322883654942814019PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","online":true,"inbox":[{"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}],"request_mid":"14339482604127316574","pass":0}],"read":[],"outbox":[],"sending":[],"sent":[],"done":[{"msgtype":"users_sha256","mid":"14339482262471399939","users":[{"user_id":"3ueoms/ZDLIplnMFmUY5lg+axe+gpdytOlAJEJAkL1U="},{"user_id":"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=","sha256":"¨w©ë4ìÕ?n\u000f\u000f\u0003~àö\"\u0015eâÍ»\u0003\fÛå[m"}]},{"mid":"14339482512101467220","request_mid":"14339482324570677293","msgtype":"gifts_sha256","ignore_invalid_gifts":[],"users":["JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k="],"gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë"}]},{"mid":"14339482512275033730","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:"}]},{"mid":"14339482603960257166","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:","comments":[{"cid":"14336000949698090073","sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"}]}]},{"mid":"14339482604127316574","msgtype":"request_comments","comments":["14339226827756085437"]}],"error":[]}
GiftService.receive_message_send_gifts: msg      = {"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}],"request_mid":"14339482603960257166","pass":0}
GiftService.receive_message_send_gifts: msg.pass = 0
GiftService.validate_send_gifts_message: validating send_gifts message after received
GiftService.validate_send_gifts_message: mutual_friends = ["7WOPKvINGnO9oTSgNRJauP7dJZFVxktEnG+EmlY9Xys=","5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="]
GiftService.validate_send_gifts_message: send_gifts_received_user_ids  =
GiftService.validate_send_gifts_message: send_gifts_expected_user_ids  =
GiftService.validate_send_gifts_message: send_gift_missing_user_ids    =
GiftService.validate_send_gifts_message: send_gift_unexpected_user_ids =
GiftService.invalid_gift: new_users_index = {}
GiftService.invalid_comment: new_users_index = {}
GiftService.gift_sha256_for_client: gid = 14335999822639189665, comments_str = 1,¸Ç³MÀBõ$÷éýºÝËj¢l@r0"hXö¢ÇØ, sha256 = fÄÞI£Æªò¯[wÈtÉç8IZWðA\cy-, sha256_gift = 1S·uWé}q<ÁNniNêÝÚÐY-ë¢Ü,I½¯', sha256_comments = ½mh¬1ÙÊ!Ñ
Æ®­µP{§Òì´¡î
GiftService.receive_message_send_gifts: other_server_id_to_sha256 = {"0":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}
GiftService.verify_comments_add: added cid 14339226827756085437 to verify comments buffer
GiftService.receive_message_send_gifts: Waiting for 0 gifts and 1 comments to be server validated.
GiftService.receive_message_send_gifts: mailbox.read.length = 1
GiftService.receive_message_send_gifts: verify_gifts = []
GiftService.receive_message_send_gifts: verify_comments = [{"gid":"14335999822639189665","comment":{"cid":"14339226827756085437","user_ids":[3],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":1,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ","in_verify_comments":1433948268}}]
GiftService.process_messages: mailbox.read.length = 1

client 2:
- received send_gifts message from client 1 (response to previous request comments request) - mid 14339482644876083500
- please note: 2 send_gifts messages received from client 1 - only one verify comments request send to server 2
GiftService.receive_message_send_gifts: mailbox  = {"did":"14322883654942814019","sha256":"PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","mutual_friends":[2,3],"server_id":1,"key":"14322883654942814019PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","online":true,"inbox":[],"read":[{"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[3],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":1,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[3],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":1,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ","in_verify_comments":1433948268}],"sha256":"\u0001fÄÞI£Æªò¯[wÈtÉç8IZWðA\b\\\u0000cy-","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"\u001e½mh¬1ÙÊ!Ñ\rÆ®­µP{§Òì´\u0014¡î"}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}],"request_mid":"14339482603960257166","pass":1}],"outbox":[],"sending":[],"sent":[],"done":[{"msgtype":"users_sha256","mid":"14339482262471399939","users":[{"user_id":"3ueoms/ZDLIplnMFmUY5lg+axe+gpdytOlAJEJAkL1U="},{"user_id":"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=","sha256":"¨w©ë4ìÕ?n\u000f\u000f\u0003~àö\"\u0015eâÍ»\u0003\fÛå[m"}]},{"mid":"14339482512101467220","request_mid":"14339482324570677293","msgtype":"gifts_sha256","ignore_invalid_gifts":[],"users":["JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k="],"gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë"}]},{"mid":"14339482512275033730","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:"}]},{"mid":"14339482603960257166","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:","comments":[{"cid":"14336000949698090073","sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"}]}]},{"mid":"14339482604127316574","msgtype":"request_comments","comments":["14339226827756085437"]}],"error":[]}
GiftService.receive_message_send_gifts: msg      = {"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":0,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":["5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":0}]}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}],"request_mid":"14339482604127316574","pass":0}
GiftService.receive_message_send_gifts: msg.pass = 0
GiftService.validate_send_gifts_message: validating send_gifts message after received
GiftService.validate_send_gifts_message: mutual_friends = ["7WOPKvINGnO9oTSgNRJauP7dJZFVxktEnG+EmlY9Xys=","5J5L6uh773z7PGtzfsOF/0Mn4uDk/8QUZUOLfuLnz9U="]
GiftService.validate_send_gifts_message: send_gifts_received_user_ids  =
GiftService.validate_send_gifts_message: send_gifts_expected_user_ids  =
GiftService.validate_send_gifts_message: send_gift_missing_user_ids    =
GiftService.validate_send_gifts_message: send_gift_unexpected_user_ids =
GiftService.invalid_gift: new_users_index = {}
GiftService.invalid_comment: new_users_index = {}
GiftService.gift_sha256_for_client: gid = 14335999822639189665, comments_str = 1,¸Ç³MÀBõ$÷éýºÝËj¢l@r0"hXö¢ÇØ, sha256 = fÄÞI£Æªò¯[wÈtÉç8IZWðA\cy-, sha256_gift = 1S·uWé}q<ÁNniNêÝÚÐY-ë¢Ü,I½¯', sha256_comments = ½mh¬1ÙÊ!Ñ
Æ®­µP{§Òì´¡î
GiftService.receive_message_send_gifts: other_server_id_to_sha256 = {"0":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}
GiftService.verify_comments_add: added cid 14339226827756085437 to verify comments buffer
GiftService.receive_message_send_gifts: Waiting for 0 gifts and 1 comments to be server validated.
GiftService.receive_message_send_gifts: mailbox.read.length = 2
GiftService.receive_message_send_gifts: verify_gifts = []
GiftService.receive_message_send_gifts: verify_comments = [{"gid":"14335999822639189665","comment":{"cid":"14339226827756085437","user_ids":[3],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":1,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ","in_verify_comments":1433948268}},{"gid":"14335999822639189665","comment":{"cid":"14339226827756085437","user_ids":[3],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":1,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ","in_verify_comments":1433948268}}]
GiftService.process_messages: mailbox.read.length = 2
GiftService.verify_comments_request: verify_comments.length = 2
GiftService.verify_comments_request: 1 new comment verification requests sent to server.
GiftService.process_messages: 2 messages was moved from mailbox.read to mailbox.inbox

server 2:
- client 2 ping
- received verify comment request from client 2 and saved request in verify_comments and messages tables
Started POST "/util/ping.json" for 127.0.0.1 at 2015-06-10 16:57:50 +0200
Processing by UtilController#ping as JSON
  Parameters:
    {"client_userid"=>1, "sid"=>"14339482207947420110", "client_timestamp"=>1433948270915,
     "verify_comments"=>[
        {"cid"=>"14339226827756085437", "sha256"=>"\u0094V[\u0002^è\u000Fä\\Å8NÍú5E\u008AÎ\u00191T!h!Kï\u0080£\u0082\u0084Ë\u0001", "user_ids"=>[3], "server_id"=>1, "seq"=>-8}], "util"=>{"client_userid"=>1, "sid"=>"14339482207947420110", "client_timestamp"=>1433948270915, "verify_comments"=>[{"cid"=>"14339226827756085437", "sha256"=>"\u0094V[\u0002^è\u000Fä\\Å8NÍú5E\u008AÎ\u00191T!h!Kï\u0080£\u0082\u0084Ë\u0001", "user_ids"=>[3], "server_id"=>1, "seq"=>-8}]}}
...
ping: verify_comments = [{"cid"=>"14339226827756085437", "sha256"=>"\u0094V[\u0002^è\u000Fä\\Å8NÍú5E\u008AÎ\u00191T!h!Kï\u0080£\u0082\u0084Ë\u0001", "user_ids"=>[3], "server_id"=>1, "seq"=>-8}] (Array)
verify_comments: verify_comments = [{"cid":"14339226827756085437","sha256":"V[\u0002^è\u000Fä\\Å8NÍú5EÎ\u00191T!h!Kï£Ë\u0001","user_ids":[3],"server_id":1,"seq":-8}]
verify_comments: login_user_ids = ["1616942831872982/facebook"]
   (0.4ms)  SELECT COUNT(*) FROM `users` WHERE `users`.`user_id` IN ('1616942831872982/facebook')
  CACHE (0.0ms)  SELECT COUNT(*) FROM `users` WHERE `users`.`user_id` IN ('1616942831872982/facebook')
  CACHE (0.0ms)  SELECT COUNT(*) FROM `users` WHERE `users`.`user_id` IN ('1616942831872982/facebook')
  CACHE (0.0ms)  SELECT `users`.* FROM `users` WHERE `users`.`user_id` IN ('1616942831872982/facebook')
  ServerUser Load (0.4ms)  SELECT `server_users`.* FROM `server_users` WHERE `server_users`.`user_id` IN (2)
  Friend Load (0.2ms)  SELECT `friends`.* FROM `friends` WHERE (user_id_giver in ('1616942831872982/facebook'))
  Friend Load (0.2ms)  SELECT `friends`.* FROM `friends` WHERE (user_id_giver in ('1616942831872982/facebook','4878645699741/facebook'))
  Comment Load (0.3ms)  SELECT `comments`.* FROM `comments` WHERE `comments`.`cid` IN ('14339226827756085437')
  User Load (0.2ms)  SELECT `users`.* FROM `users` WHERE `users`.`id` IN (3)
  ServerUser Load (0.2ms)  SELECT `server_users`.* FROM `server_users` WHERE `server_users`.`user_id` IN (3)
  CACHE (0.0ms)  SELECT `servers`.* FROM `servers` WHERE `servers`.`id` IN (1)
   (0.2ms)  BEGIN
  Sequence Load (0.4ms)  SELECT `sequences`.* FROM `sequences` WHERE `sequences`.`name` = 'server_mid' LIMIT 1
  SQL (0.4ms)  UPDATE `sequences` SET `value` = 13, `updated_at` = '2015-06-10 14:57:51' WHERE `sequences`.`id` = 6
   (4.5ms)  COMMIT
   (0.2ms)  BEGIN
  Sequence Load (0.4ms)  SELECT `sequences`.* FROM `sequences` WHERE `sequences`.`name` = 'verify_seq' LIMIT 1
  SQL (0.3ms)  UPDATE `sequences` SET `value` = 5, `updated_at` = '2015-06-10 14:57:51' WHERE `sequences`.`id` = 7
   (3.6ms)  COMMIT
   (0.1ms)  BEGIN
  SQL (3.7ms)  INSERT INTO `verify_comments` (`cid`, `client_seq`, `client_sha256`, `client_sid`, `created_at`, `request_mid`, `server_id`, `server_seq`, `updated_at`) VALUES ('14339226827756085437', -8, 't5HP7V58Ta6LW7R98LtpLkYgjzveJswACYZnqERap0k=', '14339482207947420110', '2015-06-10 14:57:51', 13, 1, 5, '2015-06-10 14:57:51')
   (3.5ms)  COMMIT
   (0.5ms)  SELECT COUNT(*) FROM `verify_comments` WHERE (client_sid = '14339482207947420110' and client_sha256 = 't5HP7V58Ta6LW7R98LtpLkYgjzveJswACYZnqERap0k=' and verified_at_server is not null)
verify_comments: response = []
verify_comments: server_requests = {1=>[{:seq=>5, :cid=>"14339226827756085437", :sha256=>"\u0094V[\u0002^è\u000Fä\\Å8NÍú5E\u008AÎ\u00191T!h!Kï\u0080£\u0082\u0084Ë\u0001", :user_ids=>[{:sha256=>"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=", :pseudo_user_id=>1, :sha256_updated_at=>1433405699}]}]}
block in verify_comments: verify_comments message = {:msgtype=>"verify_comments", :mid=>13, :login_users=>[{:sha256=>"3ueoms/ZDLIplnMFmUY5lg+axe+gpdytOlAJEJAkL1U=", :pseudo_user_id=>2, :sha256_updated_at=>1433405699}], :verify_comments=>[{:seq=>5, :cid=>"14339226827756085437", :sha256=>"\u0094V[\u0002^è\u000Fä\\Å8NÍú5E\u008AÎ\u00191T!h!Kï\u0080£\u0082\u0084Ë\u0001", :user_ids=>[{:sha256=>"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=", :pseudo_user_id=>1, :sha256_updated_at=>1433405699}]}]}
  SystemParameter Load (0.2ms)  SELECT `system_parameters`.* FROM `system_parameters` WHERE `system_parameters`.`name` = 'did' LIMIT 1
   (0.1ms)  BEGIN
  SQL (0.4ms)  INSERT INTO `messages` (`created_at`, `encryption`, `from_did`, `message`, `mid`, `server`, `to_did`, `updated_at`)
               VALUES ('2015-06-10 14:57:51', 'sym', '14339440354355175227', 'RHV0UnpKVzgvd052QzhwTC9YSzRZRU5vM0NDUWltVXlleUN5SUMzL0s2Sld2\nQmZUd3luNko4SGhFQ01UClFqMU11QkNPTW9hSENTWUpjZXpQZ0F5d2wzemRT\nMlkrZlcrV3l4bWNTQTc1bGxSeVdQeHNka0hOYWdCMgp1RnRjSGdvNFJXZHF1\nNDJQV1FKYmZsM0h4VnJkOUlYSkNzZ1Z5ZDBGSHQvcVlKQTNYSE9VVEVmSEJq\nbkMKUDFKdFppRVNWZ0lGd0ZUMzA0K3R2cVpWUzFsM3JEb0V3OGlLQkxJd2xv\nUklaOVJweDRZcFRveDY4MUt5CjdFTTg5cXB5ZkhXNmttTjdlc3I1cC9BQ0lB\nTWVFSVdVMi95NFE4dDlpUjBMamdUdU5DNWNqd2xLQTZGNQowZitxZEJtMVhs\na0tZY1ZUTFZMUjgxNTBuakk4MmZCLzZQSlBSWFdzVUtBdUpvdm9Pa2dySHcz\ndlJmSDQKZFVxR2JYUGIvcDV4NGpac1BSNWFiM0JRZ251Mm5EK3FLZlk2alpi\nTE5RWVMwWjJSbnV2RjhBREVTRmpMCjNucDZlUnJxaVE2Y0Vabzh1OEZzcDlr\nUXRYTE5iOU5ROWlhMm1HK1FaKzZnaUhkQmdNMmlSZEFZb1VQWQphbWpndmtr\nL25EeHhWYWFrNjgrSERsc3Z2L1V6aHVUNkpUcmJpWGRTWVVqYXNPSTNoV2VF\neXZzVXBWUW0KdDJaYzd5b2U4V0U5RjBLdWw0V3NKalJqY3c9PQo=\n', 13, 1, '14339440336843414352', '2015-06-10 14:57:51')
   (4.1ms)  COMMIT
...
ping: @json = {:old_client_timestamp=>1433948268773, :interval=>2000, :online=>[{:did=>"14322883654942814019", :sha256=>"PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=", :mutual_friends=>[2, 3], :server_id=>1}]}
Completed 200 OK in 378ms (Views: 0.4ms | ActiveRecord: 43.2ms)

server 2:
- server ping - send server to server verify comments request in messgages table to server 1:
Started POST "/util/ping.json" for 127.0.0.1 at 2015-06-10 16:57:52 +0200
Processing by UtilController#ping as JSON
  Parameters: {"client_userid"=>1, "sid"=>"14323002459733920704", "client_timestamp"=>1433948272207, "messages"=>[{"sender_did"=>"14339440336843414352", "receiver_did"=>"14339440354355175227", "server"=>true, "encryption"=>"sym", "message"=>"RHV0UnpKVzgvd1BQZUhoaWpScDZDdmdzb0lOdzdPRzVpL1FhOFRQS08rbDRz\nNnBIYVVEN0J6bXJ6VkRvClBzRXJuKzllK2YvMzYxVlgwTEUxRjRySWRnSG84\nckh3a3JrZHhLVU5hWlhWdC8wbnZkREVXOXl4bU1jYQp2Mll6eE93ZUdCTkVW\naWdBWnZJTGhJNE1hV3Ard3BMc0t0ZXlBMG5CQlY3TndOQk1JN0U5cndzS01y\nZjkKRTA5SC9nVTJ5UUlLTER6dEJiUGxYckJxR1dwdldzeHZmMWlvOURGdmFW\nalBpOFVkOFNoQldpL3dlY2d0CldtSFhvSmQxRFdJWGtISDVzMXNxV0JjUnNE\nQUpReFJtaXFpQU1QS0lIcnlRTmxNdkJyaWYwVFpVdmxydQpPd1RRR2daWDJV\nVGkrY3hUYVRncUhuS3RmTi9ZNWxKWmV6LytJRythaHcrcGt4N2g1MFZYSFNj\nVUpmWGUKYmMwQ0NzZDRnaThha0tBRWlNejZFcTFRaG02djI5TVlPaXpyNms3\nLzZER0hZVEF1WVpqRXc4ZFFmUEllCmYwdFVralU9Cg==\n"}, {"sender_did"=>"14339440336843414352", "receiver_did"=>"14339440354355175227", "server"=>true, "encryption"=>"sym", "message"=>"RHV0UnpKVzgvd094c1JMSVczWTZiOGdTNXp0QXNqb2p4bWY1UG9UVmorMjNF\ndWN6SjZoK0hJa2NLMTdwCk84a3dkRDdqbElGYnA3TjRRcGN4Z1VNV0pYSnN3\nbnFlbDJoSTdmOWRLZi9wK0tHa0hyb1JYK2lFeXE1WApSZmtXZG1lSnFOK3J4\nb0RTUWlDU1dMK2RTbGU4RnBjN3B3bVYvZXQ5ZUw1WCtINnh4ME4zQ3AzdGFw\nZjEKN1hUQzhPcHFKQy9yeXJ5WTNCT3Y0MjVMbm9qSkJiUW90U3VGa1QxQ0Z1\neDQ2QW5RQkpCT3FmcFloOWVGCnFTYjFueDJ3QVNjazRBd0ttTk02b2t2WXUv\nTkI2bmVxb0V1MWdqMnFSU3N2RThOK1hzVzR6YTVjQnVDMApXQzQxYkFjL0h0\nSE01U2Zmb0ZFdDlOTmx2cGVJN0wwUUpiK3FqRWhCMjJJa0RUZzhidFhCbVpm\na2U0Y2MKV1hWTm1hTGxwMVE5eTNTNlBJeVRvK0VCc0E5OCs3d29TcXpydC9Z\nbVlLNGtiT1p0WnZKdndmMi8vUDVtClFXbHNFNTgzR3h6NlpyOWFzdG8yVi9v\nVG9QN3lsWlk5bmYvaG9ld1NHYjlUbmlmQjVBdXFzSTJtNTk0bQo2WEh2bkRh\nN2NscVdLTG1sRys0Y2swWGVLWkNueHR6cms2RjJxdVpBUUovK0xML3A5WXFi\nUTFOMXRra28KN1RQUktKQTU0dzhPM1NlS2xiOXpNcFRsMGYra3hwRUY0MHpS\neVUyVWJVK0JjMFc4KytpbnIxRDhicmRVClpHdzB0MTBJQTRiei8zN1RVbGRF\nWFIvdlVRQlJlWmJKZnFObk5YOUZ5VnYzY0V3YVlHSlFxbjczK0hVNApQK1ox\nNHJFYVJTV2ZGL01PZGhrNFFsOVZRM0RSTzBMZm9MU2ZkR1YwY0tuK1JaNVVM\nNU5WQi9VPQo=\n"}], "util"=>{"client_userid"=>1, "sid"=>"14323002459733920704", "client_timestamp"=>1433948272207, "messages"=>[{"sender_did"=>"14339440336843414352", "receiver_did"=>"14339440354355175227", "server"=>true, "encryption"=>"sym", "message"=>"RHV0UnpKVzgvd1BQZUhoaWpScDZDdmdzb0lOdzdPRzVpL1FhOFRQS08rbDRz\nNnBIYVVEN0J6bXJ6VkRvClBzRXJuKzllK2YvMzYxVlgwTEUxRjRySWRnSG84\nckh3a3JrZHhLVU5hWlhWdC8wbnZkREVXOXl4bU1jYQp2Mll6eE93ZUdCTkVW\naWdBWnZJTGhJNE1hV3Ard3BMc0t0ZXlBMG5CQlY3TndOQk1JN0U5cndzS01y\nZjkKRTA5SC9nVTJ5UUlLTER6dEJiUGxYckJxR1dwdldzeHZmMWlvOURGdmFW\nalBpOFVkOFNoQldpL3dlY2d0CldtSFhvSmQxRFdJWGtISDVzMXNxV0JjUnNE\nQUpReFJtaXFpQU1QS0lIcnlRTmxNdkJyaWYwVFpVdmxydQpPd1RRR2daWDJV\nVGkrY3hUYVRncUhuS3RmTi9ZNWxKWmV6LytJRythaHcrcGt4N2g1MFZYSFNj\nVUpmWGUKYmMwQ0NzZDRnaThha0tBRWlNejZFcTFRaG02djI5TVlPaXpyNms3\nLzZER0hZVEF1WVpqRXc4ZFFmUEllCmYwdFVralU9Cg==\n"}, {"sender_did"=>"14339440336843414352", "receiver_did"=>"14339440354355175227", "server"=>true, "encryption"=>"sym", "message"=>"RHV0UnpKVzgvd094c1JMSVczWTZiOGdTNXp0QXNqb2p4bWY1UG9UVmorMjNF\ndWN6SjZoK0hJa2NLMTdwCk84a3dkRDdqbElGYnA3TjRRcGN4Z1VNV0pYSnN3\nbnFlbDJoSTdmOWRLZi9wK0tHa0hyb1JYK2lFeXE1WApSZmtXZG1lSnFOK3J4\nb0RTUWlDU1dMK2RTbGU4RnBjN3B3bVYvZXQ5ZUw1WCtINnh4ME4zQ3AzdGFw\nZjEKN1hUQzhPcHFKQy9yeXJ5WTNCT3Y0MjVMbm9qSkJiUW90U3VGa1QxQ0Z1\neDQ2QW5RQkpCT3FmcFloOWVGCnFTYjFueDJ3QVNjazRBd0ttTk02b2t2WXUv\nTkI2bmVxb0V1MWdqMnFSU3N2RThOK1hzVzR6YTVjQnVDMApXQzQxYkFjL0h0\nSE01U2Zmb0ZFdDlOTmx2cGVJN0wwUUpiK3FqRWhCMjJJa0RUZzhidFhCbVpm\na2U0Y2MKV1hWTm1hTGxwMVE5eTNTNlBJeVRvK0VCc0E5OCs3d29TcXpydC9Z\nbVlLNGtiT1p0WnZKdndmMi8vUDVtClFXbHNFNTgzR3h6NlpyOWFzdG8yVi9v\nVG9QN3lsWlk5bmYvaG9ld1NHYjlUbmlmQjVBdXFzSTJtNTk0bQo2WEh2bkRh\nN2NscVdLTG1sRys0Y2swWGVLWkNueHR6cms2RjJxdVpBUUovK0xML3A5WXFi\nUTFOMXRra28KN1RQUktKQTU0dzhPM1NlS2xiOXpNcFRsMGYra3hwRUY0MHpS\neVUyVWJVK0JjMFc4KytpbnIxRDhicmRVClpHdzB0MTBJQTRiei8zN1RVbGRF\nWFIvdlVRQlJlWmJKZnFObk5YOUZ5VnYzY0V3YVlHSlFxbjczK0hVNApQK1ox\nNHJFYVJTV2ZGL01PZGhrNFFsOVZRM0RSTzBMZm9MU2ZkR1YwY0tuK1JaNVVM\nNU5WQi9VPQo=\n"}]}}
...
  Message Load (0.5ms)  SELECT `messages`.* FROM `messages` WHERE `messages`.`to_did` = '14339440336843414352' AND `messages`.`server` = 1 ORDER BY `messages`.created_at ASC
  SQL (4.4ms)  DELETE FROM `messages` WHERE `messages`.`to_did` = '14339440336843414352' AND `messages`.`server` = 1
messages: output_messages =
  {:messages=>[{:sender_did=>"14339440354355175227", :server=>true, :encryption=>"sym",
  :message=>"RHV0UnpKVzgvd052QzhwTC9YSzRZRU5vM0NDUWltVXlleUN5SUMzL0s2Sld2\nQmZUd3luNko4SGhFQ01UClFqMU11QkNPTW9hSENTWUpjZXpQZ0F5d2wzemRT\nMlkrZlcrV3l4bWNTQTc1bGxSeVdQeHNka0hOYWdCMgp1RnRjSGdvNFJXZHF1\nNDJQV1FKYmZsM0h4VnJkOUlYSkNzZ1Z5ZDBGSHQvcVlKQTNYSE9VVEVmSEJq\nbkMKUDFKdFppRVNWZ0lGd0ZUMzA0K3R2cVpWUzFsM3JEb0V3OGlLQkxJd2xv\nUklaOVJweDRZcFRveDY4MUt5CjdFTTg5cXB5ZkhXNmttTjdlc3I1cC9BQ0lB\nTWVFSVdVMi95NFE4dDlpUjBMamdUdU5DNWNqd2xLQTZGNQowZitxZEJtMVhs\na0tZY1ZUTFZMUjgxNTBuakk4MmZCLzZQSlBSWFdzVUtBdUpvdm9Pa2dySHcz\ndlJmSDQKZFVxR2JYUGIvcDV4NGpac1BSNWFiM0JRZ251Mm5EK3FLZlk2alpi\nTE5RWVMwWjJSbnV2RjhBREVTRmpMCjNucDZlUnJxaVE2Y0Vabzh1OEZzcDlr\nUXRYTE5iOU5ROWlhMm1HK1FaKzZnaUhkQmdNMmlSZEFZb1VQWQphbWpndmtr\nL25EeHhWYWFrNjgrSERsc3Z2L1V6aHVUNkpUcmJpWGRTWVVqYXNPSTNoV2VF\neXZzVXBWUW0KdDJaYzd5b2U4V0U5RjBLdWw0V3NKalJqY3c9PQo=\n", :receiver_did=>"14339440336843414352"}, {:sender_did=>"14339440354355175227", :server=>true, :encryption=>"sym", :message=>"RHV0UnpKVzgvd1BQZUhoaWpScDZDdmdzb0lOdzdPRzVpL1FhOFRQS08rbDRz\nNnBIYVVEN0J6bXJ6VkRvClBzRXJuKzllK2YvMzYxVlgwTEUxRjRySWRnSG84\nckh3a3JrZHhLVU5hWlhWdC8wbnZkREVXOXl4bVBzUApBZXdDVmpHTitlMFhO\ncW9sa05PMGNKTmlmMmxWVjc3VWkxZ1RlWS85ZU8zMTRRUW11cTRWTm4yQzQ3\nOU0KK085eW1EN0pTM3BEYVB2SHZ4TWFEcVAwZ00ydEg2b214MFlxM0VmQWpX\nUy8yaHd6bm5mcGNmUmw4eWNoClFaWjZoZlpFY1RsV2FFZTdVSzVBamwydVdu\nUWhtWUFpdldtRWxiejFXcXNLZnV1Q2dlQTVRdGdINE8ydApFb29Ra3hXbDgv\nakJTQTVOejJ5Z3d0NVREQjBIU0lCZEh1WjNHVThBWFVvQVVzbjZudTlYYzh3\nOFAwMW0KTHRXNXk2SUlIRzFTVExTMVRLcW5ZRGRzWWlMRlVpTWxpWDEzSlYw\nS3hHbmVidmRnU3B0eWxxd2JXZGQyCnVmWklqRVU9Cg==\n", :receiver_did=>"14339440336843414352"}, {:sender_did=>"14339440354355175227", :server=>true, :encryption=>"sym", :message=>"RHV0UnpKVzgvd1BkMitsbUdJb1N5RnZLTUovRFpFak9qOTV3Y2xmMXp4QT0K\n", :receiver_did=>"14339440336843414352"}]}
ping: @json =
  {:old_client_timestamp=>1433948270087, :interval=>1661, :messages=>{:messages=>[{:sender_did=>"14339440354355175227", :server=>true, :encryption=>"sym",
   :message=>"RHV0UnpKVzgvd052QzhwTC9YSzRZRU5vM0NDUWltVXlleUN5SUMzL0s2Sld2\nQmZUd3luNko4SGhFQ01UClFqMU11QkNPTW9hSENTWUpjZXpQZ0F5d2wzemRT\nMlkrZlcrV3l4bWNTQTc1bGxSeVdQeHNka0hOYWdCMgp1RnRjSGdvNFJXZHF1\nNDJQV1FKYmZsM0h4VnJkOUlYSkNzZ1Z5ZDBGSHQvcVlKQTNYSE9VVEVmSEJq\nbkMKUDFKdFppRVNWZ0lGd0ZUMzA0K3R2cVpWUzFsM3JEb0V3OGlLQkxJd2xv\nUklaOVJweDRZcFRveDY4MUt5CjdFTTg5cXB5ZkhXNmttTjdlc3I1cC9BQ0lB\nTWVFSVdVMi95NFE4dDlpUjBMamdUdU5DNWNqd2xLQTZGNQowZitxZEJtMVhs\na0tZY1ZUTFZMUjgxNTBuakk4MmZCLzZQSlBSWFdzVUtBdUpvdm9Pa2dySHcz\ndlJmSDQKZFVxR2JYUGIvcDV4NGpac1BSNWFiM0JRZ251Mm5EK3FLZlk2alpi\nTE5RWVMwWjJSbnV2RjhBREVTRmpMCjNucDZlUnJxaVE2Y0Vabzh1OEZzcDlr\nUXRYTE5iOU5ROWlhMm1HK1FaKzZnaUhkQmdNMmlSZEFZb1VQWQphbWpndmtr\nL25EeHhWYWFrNjgrSERsc3Z2L1V6aHVUNkpUcmJpWGRTWVVqYXNPSTNoV2VF\neXZzVXBWUW0KdDJaYzd5b2U4V0U5RjBLdWw0V3NKalJqY3c9PQo=\n", :receiver_did=>"14339440336843414352"}, {:sender_did=>"14339440354355175227", :server=>true, :encryption=>"sym", :message=>"RHV0UnpKVzgvd1BQZUhoaWpScDZDdmdzb0lOdzdPRzVpL1FhOFRQS08rbDRz\nNnBIYVVEN0J6bXJ6VkRvClBzRXJuKzllK2YvMzYxVlgwTEUxRjRySWRnSG84\nckh3a3JrZHhLVU5hWlhWdC8wbnZkREVXOXl4bVBzUApBZXdDVmpHTitlMFhO\ncW9sa05PMGNKTmlmMmxWVjc3VWkxZ1RlWS85ZU8zMTRRUW11cTRWTm4yQzQ3\nOU0KK085eW1EN0pTM3BEYVB2SHZ4TWFEcVAwZ00ydEg2b214MFlxM0VmQWpX\nUy8yaHd6bm5mcGNmUmw4eWNoClFaWjZoZlpFY1RsV2FFZTdVSzVBamwydVdu\nUWhtWUFpdldtRWxiejFXcXNLZnV1Q2dlQTVRdGdINE8ydApFb29Ra3hXbDgv\nakJTQTVOejJ5Z3d0NVREQjBIU0lCZEh1WjNHVThBWFVvQVVzbjZudTlYYzh3\nOFAwMW0KTHRXNXk2SUlIRzFTVExTMVRLcW5ZRGRzWWlMRlVpTWxpWDEzSlYw\nS3hHbmVidmRnU3B0eWxxd2JXZGQyCnVmWklqRVU9Cg==\n", :receiver_did=>"14339440336843414352"}, {:sender_did=>"14339440354355175227", :server=>true, :encryption=>"sym", :message=>"RHV0UnpKVzgvd1BkMitsbUdJb1N5RnZLTUovRFpFak9qOTV3Y2xmMXp4QT0K\n", :receiver_did=>"14339440336843414352"}]}}
Completed 200 OK in 235ms (Views: 0.9ms | ActiveRecord: 58.9ms)

client 2:
- elapsed time 5 seconds. waiting for remote verification for new comment - mid 14339482644601033312
GiftService.receive_message_send_gifts: mailbox  = {"did":"14322883654942814019","sha256":"PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","mutual_friends":[2,3],"server_id":1,"key":"14322883654942814019PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","online":true,"inbox":[{"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[3],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":1,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[3],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":1,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ","in_verify_comments":1433948268,"verify_seq":-8}],"sha256":"\u0001fÄÞI£Æªò¯[wÈtÉç8IZWðA\b\\\u0000cy-","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"\u001e½mh¬1ÙÊ!Ñ\rÆ®­µP{§Òì´\u0014¡î"}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}],"request_mid":"14339482604127316574","pass":1}],"read":[],"outbox":[],"sending":[],"sent":[],"done":[{"msgtype":"users_sha256","mid":"14339482262471399939","users":[{"user_id":"3ueoms/ZDLIplnMFmUY5lg+axe+gpdytOlAJEJAkL1U="},{"user_id":"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=","sha256":"¨w©ë4ìÕ?n\u000f\u000f\u0003~àö\"\u0015eâÍ»\u0003\fÛå[m"}]},{"mid":"14339482512101467220","request_mid":"14339482324570677293","msgtype":"gifts_sha256","ignore_invalid_gifts":[],"users":["JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k="],"gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë"}]},{"mid":"14339482512275033730","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:"}]},{"mid":"14339482603960257166","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:","comments":[{"cid":"14336000949698090073","sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"}]}]},{"mid":"14339482604127316574","msgtype":"request_comments","comments":["14339226827756085437"]}],"error":[]}
GiftService.receive_message_send_gifts: msg      = {"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[3],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":1,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[3],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":1,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ","in_verify_comments":1433948268,"verify_seq":-8}],"sha256":"\u0001fÄÞI£Æªò¯[wÈtÉç8IZWðA\b\\\u0000cy-","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"\u001e½mh¬1ÙÊ!Ñ\rÆ®­µP{§Òì´\u0014¡î"}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}],"request_mid":"14339482603960257166","pass":1}
GiftService.receive_message_send_gifts: msg.pass = 1
GiftService.receive_message_send_gifts: Waited 5 seconds for comment 14339226827756085437 verification
GiftService.receive_message_send_gifts: Waiting for 0 gifts and 1 comments to be server validated.
GiftService.receive_message_send_gifts: mailbox.read.length = 1
GiftService.receive_message_send_gifts: verify_gifts = []
GiftService.receive_message_send_gifts: verify_comments = []
GiftService.process_messages: mailbox.read.length = 1

client 2:
- elapsed time 5 seconds. waiting for remote verification for new comment - mid 14339482644876083500 - todo: why 2 send_gifts messages?
GiftService.receive_message_send_gifts: mailbox  = {"did":"14322883654942814019","sha256":"PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","mutual_friends":[2,3],"server_id":1,"key":"14322883654942814019PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","online":true,"inbox":[],"read":[{"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[3],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":1,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[3],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":1,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ","in_verify_comments":1433948268,"verify_seq":-8}],"sha256":"\u0001fÄÞI£Æªò¯[wÈtÉç8IZWðA\b\\\u0000cy-","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"\u001e½mh¬1ÙÊ!Ñ\rÆ®­µP{§Òì´\u0014¡î"}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}],"request_mid":"14339482603960257166","pass":1}],"outbox":[],"sending":[],"sent":[],"done":[{"msgtype":"users_sha256","mid":"14339482262471399939","users":[{"user_id":"3ueoms/ZDLIplnMFmUY5lg+axe+gpdytOlAJEJAkL1U="},{"user_id":"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=","sha256":"¨w©ë4ìÕ?n\u000f\u000f\u0003~àö\"\u0015eâÍ»\u0003\fÛå[m"}]},{"mid":"14339482512101467220","request_mid":"14339482324570677293","msgtype":"gifts_sha256","ignore_invalid_gifts":[],"users":["JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k="],"gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë"}]},{"mid":"14339482512275033730","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:"}]},{"mid":"14339482603960257166","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:","comments":[{"cid":"14336000949698090073","sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"}]}]},{"mid":"14339482604127316574","msgtype":"request_comments","comments":["14339226827756085437"]}],"error":[]}
GiftService.receive_message_send_gifts: msg      = {"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[3],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":1,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[3],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":1,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ","in_verify_comments":1433948268,"verify_seq":-8}],"sha256":"\u0001fÄÞI£Æªò¯[wÈtÉç8IZWðA\b\\\u0000cy-","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"\u001e½mh¬1ÙÊ!Ñ\rÆ®­µP{§Òì´\u0014¡î"}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}],"request_mid":"14339482604127316574","pass":1}
GiftService.receive_message_send_gifts: msg.pass = 1
GiftService.receive_message_send_gifts: Waited 5 seconds for comment 14339226827756085437 verification
GiftService.receive_message_send_gifts: Waiting for 0 gifts and 1 comments to be server validated.
GiftService.receive_message_send_gifts: mailbox.read.length = 2
GiftService.receive_message_send_gifts: verify_gifts = []
GiftService.receive_message_send_gifts: verify_comments = []
GiftService.process_messages: mailbox.read.length = 2

console 1:
- received verify comments request from server 2 & return verify_comments response to server 2
new mail: {"id":21976,"from_did":"14339440354355175227","from_sha256":null,"to_did":"14339440336843414352","to_sha256":null,"message":"RHV0UnpKVzgvd052QzhwTC9YSzRZRU5vM0NDUWltVXlleUN5SUMzL0s2Sld2\nQmZUd3luNko4SGhFQ01UClFqMU11QkNPTW9hSENTWUpjZXpQZ0F5d2wzemRT\nMlkrZlcrV3l4bWNTQTc1bGxSeVdQeHNka0hOYWdCMgp1RnRjSGdvNFJXZHF1\nNDJQV1FKYmZsM0h4VnJkOUlYSkNzZ1Z5ZDBGSHQvcVlKQTNYSE9VVEVmSEJq\nbkMKUDFKdFppRVNWZ0lGd0ZUMzA0K3R2cVpWUzFsM3JEb0V3OGlLQkxJd2xv\nUklaOVJweDRZcFRveDY4MUt5CjdFTTg5cXB5ZkhXNmttTjdlc3I1cC9BQ0lB\nTWVFSVdVMi95NFE4dDlpUjBMamdUdU5DNWNqd2xLQTZGNQowZitxZEJtMVhs\na0tZY1ZUTFZMUjgxNTBuakk4MmZCLzZQSlBSWFdzVUtBdUpvdm9Pa2dySHcz\ndlJmSDQKZFVxR2JYUGIvcDV4NGpac1BSNWFiM0JRZ251Mm5EK3FLZlk2alpi\nTE5RWVMwWjJSbnV2RjhBREVTRmpMCjNucDZlUnJxaVE2Y0Vabzh1OEZzcDlr\nUXRYTE5iOU5ROWlhMm1HK1FaKzZnaUhkQmdNMmlSZEFZb1VQWQphbWpndmtr\nL25EeHhWYWFrNjgrSERsc3Z2L1V6aHVUNkpUcmJpWGRTWVVqYXNPSTNoV2VF\neXZzVXBWUW0KdDJaYzd5b2U4V0U5RjBLdWw0V3NKalJqY3c9PQo=\n","created_at":"2015-06-10T14:57:52.000Z","updated_at":"2015-06-10T14:57:52.000Z","encryption":"sym","server":true,"key":null,"mid":null}
  Server Load (0.5ms)  SELECT `servers`.* FROM `servers` WHERE `servers`.`new_did` = '14339440354355175227' LIMIT 1
receive_message: received sym encrypted message
receive_message: from_did = 14339440354355175227, password = yrfN33uhBrnlFtlzfXMi50qWU4XFiLzJoXPXs3sPmSzSslvAeDYNGj8IOt3WEcvSeE3uDZEPWeTAgGoUCtnjeLS7QaL4aoRxei7x3dmhomEpV6B32jMbdEefvv7QJAXDXOunyeEogb0jQFDw2OCGtRG6Y7cQAaRb
receive_message: message_json = {"msgtype":"verify_comments","mid":13,"login_users":[{"sha256":"3ueoms/ZDLIplnMFmUY5lg+axe+gpdytOlAJEJAkL1U=","pseudo_user_id":2,"sha256_updated_at":1433405699}],"verify_comments":[{"seq":5,"cid":"14339226827756085437","sha256":"V[\u0002^è\u000Fä\\Å8NÍú5EÎ\u00191T!h!Kï£Ë\u0001","user_ids":[{"sha256":"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=","pseudo_user_id":1,"sha256_updated_at":1433405699}]}]}
  SQL (3.6ms)  SELECT `server_users`.`id` AS t0_r0, `server_users`.`server_id` AS t0_r1, `server_users`.`user_id` AS t0_r2, `server_users`.`verified_at` AS t0_r3, `server_users`.`created_at` AS t0_r4, `server_users`.`updated_at` AS t0_r5, `server_users`.`pseudo_user_id` AS t0_r6, `server_users`.`remote_pseudo_user_id` AS t0_r7, `server_users`.`remote_sha256_updated_at` AS t0_r8, `server_users`.`sha256_message_sent_at` AS t0_r9, `server_users`.`sha256_signature_received_at` AS t0_r10, `users`.`id` AS t1_r0, `users`.`user_id` AS t1_r1, `users`.`user_name` AS t1_r2, `users`.`created_at` AS t1_r3, `users`.`updated_at` AS t1_r4, `users`.`currency` AS t1_r5, `users`.`balance` AS t1_r6, `users`.`balance_at` AS t1_r7, `users`.`no_api_friends` AS t1_r8, `users`.`negative_interest` AS t1_r9, `users`.`api_profile_url` AS t1_r10, `users`.`api_profile_picture_url` AS t1_r11, `users`.`deleted_at` AS t1_r12, `users`.`last_login_at` AS t1_r13, `users`.`deauthorized_at` AS t1_r14, `users`.`last_friends_find_at` AS t1_r15, `users`.`language` AS t1_r16, `users`.`access_token` AS t1_r17, `users`.`access_token_expires` AS t1_r18, `users`.`refresh_token` AS t1_r19, `users`.`sha256` AS t1_r20, `users`.`old_sha256` AS t1_r21, `users`.`sha256_updated_at` AS t1_r22, `users`.`friend_sha256_updated_at` AS t1_r23, `users`.`remote_sha256_updated_at` AS t1_r24, `users`.`remote_sha256_update_info` AS t1_r25 FROM `server_users` LEFT OUTER JOIN `users` ON `users`.`id` = `server_users`.`user_id` WHERE ((users.sha256 in ('3ueoms/ZDLIplnMFmUY5lg+axe+gpdytOlAJEJAkL1U=') or pseudo_user_id in (2)) and server_id = 1 and verified_at is not null)
block in from_sha256s_to_user_ids: user = {"id":3,"user_id":"1563545817212684/facebook","user_name":"Jan Mobilos Roslind","created_at":"2015-05-22T10:49:01.000Z","updated_at":"2015-06-04T08:14:45.000Z","currency":null,"balance":null,"balance_at":null,"no_api_friends":null,"negative_interest":null,"api_profile_url":null,"api_profile_picture_url":"https://fbcdn-profile-a.akamaihd.net/hprofile-ak-xat1/v/t1.0-1/c17.0.100.100/p100x100/10609482_1516580325242567_8022167412578042073_n.jpg?oh=136917fb05c830d20813ccede83d190f\u0026oe=55E7B7F9\u0026__gda__=1441935660_9108318547a381525245881d5323c05b","deleted_at":null,"last_login_at":null,"deauthorized_at":null,"last_friends_find_at":null,"language":null,"access_token":null,"access_token_expires":null,"refresh_token":null,"sha256":"3ueoms/ZDLIplnMFmUY5lg+axe+gpdytOlAJEJAkL1U=","old_sha256":"k+CdHUUyHnycPKgufzOseRtR7ke5ZJjSE/8MuPm1Dv4=","sha256_updated_at":"2015-06-04T08:14:44.000Z","friend_sha256_updated_at":null,"remote_sha256_updated_at":null,"remote_sha256_update_info":null}
receive_verify_comments_req: login_user_ids = 1563545817212684/facebook
receive_verify_comments_req: verify_comments (1) = [{"seq"=>5, "cid"=>"14339226827756085437", "sha256"=>"\u0094V[\u0002^è\u000Fä\\Å8NÍú5E\u008AÎ\u00191T!h!Kï\u0080£\u0082\u0084Ë\u0001", "user_ids"=>[{"sha256"=>"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=", "pseudo_user_id"=>1, "sha256_updated_at"=>1433405699}]}]
  SQL (0.8ms)  SELECT `server_users`.`id` AS t0_r0, `server_users`.`server_id` AS t0_r1, `server_users`.`user_id` AS t0_r2, `server_users`.`verified_at` AS t0_r3, `server_users`.`created_at` AS t0_r4, `server_users`.`updated_at` AS t0_r5, `server_users`.`pseudo_user_id` AS t0_r6, `server_users`.`remote_pseudo_user_id` AS t0_r7, `server_users`.`remote_sha256_updated_at` AS t0_r8, `server_users`.`sha256_message_sent_at` AS t0_r9, `server_users`.`sha256_signature_received_at` AS t0_r10, `users`.`id` AS t1_r0, `users`.`user_id` AS t1_r1, `users`.`user_name` AS t1_r2, `users`.`created_at` AS t1_r3, `users`.`updated_at` AS t1_r4, `users`.`currency` AS t1_r5, `users`.`balance` AS t1_r6, `users`.`balance_at` AS t1_r7, `users`.`no_api_friends` AS t1_r8, `users`.`negative_interest` AS t1_r9, `users`.`api_profile_url` AS t1_r10, `users`.`api_profile_picture_url` AS t1_r11, `users`.`deleted_at` AS t1_r12, `users`.`last_login_at` AS t1_r13, `users`.`deauthorized_at` AS t1_r14, `users`.`last_friends_find_at` AS t1_r15, `users`.`language` AS t1_r16, `users`.`access_token` AS t1_r17, `users`.`access_token_expires` AS t1_r18, `users`.`refresh_token` AS t1_r19, `users`.`sha256` AS t1_r20, `users`.`old_sha256` AS t1_r21, `users`.`sha256_updated_at` AS t1_r22, `users`.`friend_sha256_updated_at` AS t1_r23, `users`.`remote_sha256_updated_at` AS t1_r24, `users`.`remote_sha256_update_info` AS t1_r25 FROM `server_users` LEFT OUTER JOIN `users` ON `users`.`id` = `server_users`.`user_id` WHERE ((users.sha256 in ('JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=') or pseudo_user_id in (1)) and server_id = 1 and verified_at is not null)
block in from_sha256s_to_user_ids: user = {"id":2,"user_id":"1705481075/facebook","user_name":"Jan Roslind","created_at":"2015-05-22T10:48:57.000Z","updated_at":"2015-06-10T07:51:32.000Z","currency":"USD","balance":{"BALANCE":0.0},"balance_at":"2015-06-08","no_api_friends":1,"negative_interest":{"BALANCE":0.0},"api_profile_url":"https://www.facebook.com/1705481075","api_profile_picture_url":"https://fbcdn-profile-a.akamaihd.net/hprofile-ak-xfa1/v/t1.0-1/p100x100/996138_4574555377673_8850863452088448507_n.jpg?oh=228acdadfea9672b98b35c92490eefcc\u0026oe=55F03C27\u0026__gda__=1441288074_3abae55d8054a7a65a18fc525d6eee61","deleted_at":null,"last_login_at":"2015-06-08T08:06:49.000Z","deauthorized_at":null,"last_friends_find_at":"2015-06-06T07:11:28.000Z","language":"en","access_token":null,"access_token_expires":null,"refresh_token":null,"sha256":"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=","old_sha256":"7TXVE0hsVwC9iJneZ9MjESM2qG+go3VZ6fg1a4Y3Pbw=","sha256_updated_at":"2015-06-04T08:14:44.000Z","friend_sha256_updated_at":null,"remote_sha256_updated_at":null,"remote_sha256_update_info":null}
receive_verify_comments_req: no_errors = 0, response.size = 0, request_on_hold.size = 0, local_request.size = 1
receive_verify_comments_req: verify_comments (2) = [{"seq"=>5, "cid"=>"14339226827756085437", "sha256"=>"\u0094V[\u0002^è\u000Fä\\Å8NÍú5E\u008AÎ\u00191T!h!Kï\u0080£\u0082\u0084Ë\u0001", "user_ids"=>[{"sha256"=>"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=", "pseudo_user_id"=>1, "sha256_updated_at"=>1433405699, "status"=>"valid"}]}]
verify_comments: verify_comments = [{"seq":5,"cid":"14339226827756085437","sha256":"V[\u0002^è\u000Fä\\Å8NÍú5EÎ\u00191T!h!Kï£Ë\u0001","user_ids":[2]}]
verify_comments: login_user_ids = ["1563545817212684/facebook"]
   (0.5ms)  SELECT COUNT(*) FROM `users` WHERE `users`.`user_id` IN ('1563545817212684/facebook')
   (0.2ms)  SELECT COUNT(*) FROM `users` WHERE `users`.`user_id` IN ('1563545817212684/facebook')
   (0.2ms)  SELECT COUNT(*) FROM `users` WHERE `users`.`user_id` IN ('1563545817212684/facebook')
  User Load (0.4ms)  SELECT `users`.* FROM `users` WHERE `users`.`user_id` IN ('1563545817212684/facebook')
  ServerUser Load (0.4ms)  SELECT `server_users`.* FROM `server_users` WHERE `server_users`.`user_id` IN (3)
  Friend Load (0.6ms)  SELECT `friends`.* FROM `friends` WHERE (user_id_giver in ('1563545817212684/facebook'))
  Friend Load (0.2ms)  SELECT `friends`.* FROM `friends` WHERE (user_id_giver in ('1563545817212684/facebook','1705481075/facebook'))
  Comment Load (0.3ms)  SELECT `comments`.* FROM `comments` WHERE `comments`.`cid` IN ('14339226827756085437')
  User Load (0.6ms)  SELECT `users`.* FROM `users` WHERE `users`.`id` IN (2)
  ServerUser Load (0.4ms)  SELECT `server_users`.* FROM `server_users` WHERE `server_users`.`user_id` IN (2)
   (0.4ms)  SELECT COUNT(*) FROM `verify_comments` WHERE (client_sid = NULL and client_sha256 = NULL and verified_at_server is not null)
verify_comments: response = [{:seq=>5, :cid=>"14339226827756085437", :verified_at_server=>true}]
verify_comments: server_requests = {}
receive_verify_comments_req: local_verify_comments_request = [{"seq"=>5, "cid"=>"14339226827756085437", "sha256"=>"\u0094V[\u0002^è\u000Fä\\Å8NÍú5E\u008AÎ\u00191T!h!Kï\u0080£\u0082\u0084Ë\u0001", "user_ids"=>[2]}]
receive_verify_comments_req: local_verify_comments_response = {:comments=>[{:seq=>5, :cid=>"14339226827756085437", :verified_at_server=>true}]}
receive_verify_comments_req: local_verify_comments_error =
receive_verify_comments_req: verify_comments_response = [{:seq=>5, :cid=>"14339226827756085437", :verified_at_server=>true}]
   (0.2ms)  BEGIN
  Sequence Load (0.4ms)  SELECT `sequences`.* FROM `sequences` WHERE `sequences`.`name` = 'server_mid' LIMIT 1
  SQL (0.5ms)  UPDATE `sequences` SET `value` = 15, `updated_at` = '2015-06-10 14:57:52' WHERE `sequences`.`id` = 6
   (4.5ms)  COMMIT
  SystemParameter Load (0.2ms)  SELECT `system_parameters`.* FROM `system_parameters` WHERE `system_parameters`.`name` = 'did' LIMIT 1
   (0.2ms)  BEGIN
  SQL (0.6ms)  INSERT INTO `messages` (`created_at`, `encryption`, `from_did`, `message`, `mid`, `server`, `to_did`, `updated_at`) VALUES ('2015-06-10 14:57:52', 'sym', '14339440336843414352', 'RHV0UnpKVzgvd052QzhwTC9YSzRZRU5vM0NDUWltVXl6ZmdqNTFHQk92RE5k\nTXpsRGtSamxha0VUa29qCkVQMlRYMFh6bDk0dnVwYjQyb2NjWHJLRmt1Z243\ncEMxYUlSMytJNTBEMTk1QVJ1eCs4aWZtaS9DR1U4TAp1cm9oTFVUbmg4ZnBZ\ndmU5WW1IZ3pabEw4RDNEZGZIU0N2clg4YmtjQUFEd21iWHMrdnBmS0hIWlZK\ncmMKQmlCVjVtVXVMd3E4Cg==\n', 15, 1, '14339440354355175227', '2015-06-10 14:57:52')
   (6.3ms)  COMMIT
   (0.6ms)  BEGIN
  SQL (0.5ms)  DELETE FROM `messages` WHERE `messages`.`id` = 21976
   (3.1ms)  COMMIT


server 2:
- ping from server 1
- verify_comments request has previously been sent to server 1 - now receiving verify_comments response from server 1 - will be returned to client 2 in next ping
new mail: {"id":713,"from_did":"14339440336843414352","from_sha256":null,"to_did":"14339440354355175227","to_sha256":null,"message":"RHV0UnpKVzgvd052QzhwTC9YSzRZRU5vM0NDUWltVXl6ZmdqNTFHQk92RE5k\nTXpsRGtSamxha0VUa29qCkVQMlRYMFh6bDk0dnVwYjQyb2NjWHJLRmt1Z243\ncEMxYUlSMytJNTBEMTk1QVJ1eCs4aWZtaS9DR1U4TAp1cm9oTFVUbmg4ZnBZ\ndmU5WW1IZ3pabEw4RDNEZGZIU0N2clg4YmtjQUFEd21iWHMrdnBmS0hIWlZK\ncmMKQmlCVjVtVXVMd3E4Cg==\n","created_at":"2015-06-10T14:57:54.000Z","updated_at":"2015-06-10T14:57:54.000Z","encryption":"sym","server":true,"key":null,"mid":null}
  Server Load (0.4ms)  SELECT `servers`.* FROM `servers` WHERE `servers`.`new_did` = '14339440336843414352' LIMIT 1
receive_message: received sym encrypted message
receive_message: from_did = 14339440336843414352, password = yrfN33uhBrnlFtlzfXMi50qWU4XFiLzJoXPXs3sPmSzSslvAeDYNGj8IOt3WEcvSeE3uDZEPWeTAgGoUCtnjeLS7QaL4aoRxei7x3dmhomEpV6B32jMbdEefvv7QJAXDXOunyeEogb0jQFDw2OCGtRG6Y7cQAaRb
receive_message: message_json = {"msgtype":"verify_comments","verify_comments":[{"seq":5,"cid":"14339226827756085437","verified_at_server":true}],"mid":15,"request_mid":13}
receive_verify_comments_res: mid = 15, request_mid = 13
receive_verify_comments_res: verify_comments = [{"seq"=>5, "cid"=>"14339226827756085437", "verified_at_server"=>true}]
receive_verify_comments_res: error        =  (NilClass)
  VerifyComment Load (0.4ms)  SELECT `verify_comments`.* FROM `verify_comments` WHERE `verify_comments`.`server_seq` IN (5)
   (0.2ms)  BEGIN
  SQL (0.4ms)  UPDATE `verify_comments` SET `verified_at_server` = 1, `updated_at` = '2015-06-10 14:57:55' WHERE `verify_comments`.`id` = 1
   (5.1ms)  COMMIT
receive_verify_comments_res: verify_comments.size = 1, unknown_seq.size = 0, invalid_server_id.size = 0, invalid_cid.size = 0, invalid_response.size = 0, identical_response.size = 0, ok_response.size = 1
   (0.2ms)  BEGIN
  SQL (0.4ms)  UPDATE `verify_comments` SET `response_mid` = 15, `updated_at` = '2015-06-10 14:57:55' WHERE `verify_comments`.`id` = 1
   (5.1ms)  COMMIT
   (0.2ms)  BEGIN
  SQL (0.4ms)  DELETE FROM `messages` WHERE `messages`.`id` = 713
   (5.6ms)  COMMIT

server 2:
- ping from client 2
- verify_comments response has previously been received from server 1 and is now returned to client 2 on server 2
Started POST "/util/ping.json" for 127.0.0.1 at 2015-06-10 16:57:55 +0200
Processing by UtilController#ping as JSON
  Parameters: {"client_userid"=>1, "sid"=>"14339482207947420110", "client_timestamp"=>1433948275526, "util"=>{"client_userid"=>1, "sid"=>"14339482207947420110", "client_timestamp"=>1433948275526}}
...
verify_comments: verify_comments = null
verify_comments: login_user_ids = ["1616942831872982/facebook"]
   (0.5ms)  SELECT COUNT(*) FROM `verify_comments` WHERE (client_sid = '14339482207947420110' and client_sha256 = 't5HP7V58Ta6LW7R98LtpLkYgjzveJswACYZnqERap0k=' and verified_at_server is not null)
  CACHE (0.0ms)  SELECT COUNT(*) FROM `verify_comments` WHERE (client_sid = '14339482207947420110' and client_sha256 = 't5HP7V58Ta6LW7R98LtpLkYgjzveJswACYZnqERap0k=' and verified_at_server is not null)
verify_comments: vcs.size = 1
  VerifyComment Load (0.4ms)  SELECT `verify_comments`.* FROM `verify_comments` WHERE (client_sid = '14339482207947420110' and client_sha256 = 't5HP7V58Ta6LW7R98LtpLkYgjzveJswACYZnqERap0k=' and verified_at_server is not null)
  SQL (3.7ms)  DELETE FROM `verify_comments` WHERE (client_sid = '14339482207947420110' and client_sha256 = 't5HP7V58Ta6LW7R98LtpLkYgjzveJswACYZnqERap0k=' and verified_at_server is not null)
...
ping: @json =
  {:old_client_timestamp=>1433948273337, :interval=>2000,
   :online=>[{:did=>"14322883654942814019", :sha256=>"PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=", :mutual_friends=>[2, 3], :server_id=>1}],
   :verify_comments=>{:comments=>[{:seq=>-8, :cid=>"14339226827756085437", :verified_at_server=>true}]}}
Completed 200 OK in 264ms (Views: 0.7ms | ActiveRecord: 19.9ms)

client 2:
- remote verification for new comment was received
GiftService.verify_comments_request: Warning. Found 0 local and 1 remote not yet verified comments in buffer.
GiftService.verify_comments_response: Received 1 verifications for 2 comments (2 valid and 0 invalid). todo: check 2 comments!
GiftService.process_messages: 2 messages was moved from mailbox.read to mailbox.inbox todo: check 2 messages!

client 2:
- last send_gift pass. new comment has been remote verified on server 1 and is created in client 2
GiftService.receive_message_send_gifts: mailbox  = {"did":"14322883654942814019","sha256":"PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","mutual_friends":[2,3],"server_id":1,"key":"14322883654942814019PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","online":true,"inbox":[{"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[3],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":1,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[3],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":1,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ","in_verify_comments":1433948268,"verify_seq":-8,"verified_at_server":true}],"sha256":"\u0001fÄÞI£Æªò¯[wÈtÉç8IZWðA\b\\\u0000cy-","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"\u001e½mh¬1ÙÊ!Ñ\rÆ®­µP{§Òì´\u0014¡î"}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}],"request_mid":"14339482604127316574","pass":1}],"read":[],"outbox":[],"sending":[],"sent":[],"done":[{"msgtype":"users_sha256","mid":"14339482262471399939","users":[{"user_id":"3ueoms/ZDLIplnMFmUY5lg+axe+gpdytOlAJEJAkL1U="},{"user_id":"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=","sha256":"¨w©ë4ìÕ?n\u000f\u000f\u0003~àö\"\u0015eâÍ»\u0003\fÛå[m"}]},{"mid":"14339482512101467220","request_mid":"14339482324570677293","msgtype":"gifts_sha256","ignore_invalid_gifts":[],"users":["JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k="],"gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë"}]},{"mid":"14339482512275033730","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:"}]},{"mid":"14339482603960257166","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:","comments":[{"cid":"14336000949698090073","sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"}]}]},{"mid":"14339482604127316574","msgtype":"request_comments","comments":["14339226827756085437"]}],"error":[]}
GiftService.receive_message_send_gifts: msg      = {"mid":"14339482644601033312","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[3],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":1,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[3],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":1,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ","in_verify_comments":1433948268,"verify_seq":-8,"verified_at_server":true}],"sha256":"\u0001fÄÞI£Æªò¯[wÈtÉç8IZWðA\b\\\u0000cy-","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"\u001e½mh¬1ÙÊ!Ñ\rÆ®­µP{§Òì´\u0014¡î"}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}],"request_mid":"14339482603960257166","pass":1}
GiftService.receive_message_send_gifts: msg.pass = 1
GiftService.receive_message_send_gifts: new comment 14339226827756085437 ok - comment ready for pass 2
GiftService.receive_message_send_gifts: create new comment 14339226827756085437
GiftService.invalid_comment: new_users_index = {}
GiftService.invalid_changed_gift: Not implemented
GiftService.receive_message_send_gifts: pass = 1, error report missing
GiftService.process_messages: mailbox.read.length = 0

client 2:
- ekstra send gift message with new comment - has already been created in previous send_gifts call (mid=14339482644601033312)
GiftService.receive_message_send_gifts: mailbox  = {"did":"14322883654942814019","sha256":"PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","mutual_friends":[2,3],"server_id":1,"key":"14322883654942814019PLgfzS8/kVm910QDHvi9QV/GW4QOCPf4k9rdRVhxPEo=","online":true,"inbox":[],"read":[],"outbox":[],"sending":[],"sent":[],"done":[{"msgtype":"users_sha256","mid":"14339482262471399939","users":[{"user_id":"3ueoms/ZDLIplnMFmUY5lg+axe+gpdytOlAJEJAkL1U="},{"user_id":"JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k=","sha256":"¨w©ë4ìÕ?n\u000f\u000f\u0003~àö\"\u0015eâÍ»\u0003\fÛå[m"}]},{"mid":"14339482512101467220","request_mid":"14339482324570677293","msgtype":"gifts_sha256","ignore_invalid_gifts":[],"users":["JDe0rPOIXxrpOLukEsaJu882G6yxEGtgyRCQQ/lhg+k="],"gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë"}]},{"mid":"14339482512275033730","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:"}]},{"mid":"14339482603960257166","msgtype":"check_gifts","gifts":[{"gid":"14335999822639189665","sha256":"¾\u001e:M¦ÊV\r\u0010A½!CÖõ´~Ïýà´@ßTt\u0005%Ûuë","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"lUzMD|§Æ\u0004;iðÌ Áæ/ZZc\\\u000f½LO:","comments":[{"cid":"14336000949698090073","sha256":"\u00063w¿%\u0005à\u000eö×´¶õ½X¡°\u00037\u0014e\\tú\u001dn"}]}]},{"mid":"14339482604127316574","msgtype":"request_comments","comments":["14339226827756085437"]}],"error":[]}
GiftService.receive_message_send_gifts: msg      = {"mid":"14339482644876083500","msgtype":"send_gifts","gifts":[{"gid":"14335999822639189665","giver_user_ids":[3],"receiver_user_ids":[],"created_at_client":1433599982,"created_at_server":1,"currency":"usd","direction":"giver","description":"client 1 => client 2","comments":[{"cid":"14339226827756085437","user_ids":[3],"currency":"usd","comment":"client 1 => client 2","created_at_client":1433922682,"created_at_server":1,"sha256":"¸Ç³MÀBõ$÷éý\u0011ºÝËj¢\u0004l@r0\"hXö¢ÇØ","in_verify_comments":1433948268,"verify_seq":-8,"verified_at_server":true}],"sha256":"\u0001fÄÞI£Æªò¯[wÈtÉç8IZWðA\b\\\u0000cy-","sha256_gift":"1S·uWé}q<ÁNni\u0005NêÝÚÐY-ë¢\u0018Ü\u001f,I½¯'","sha256_comments":"\u001e½mh¬1ÙÊ!Ñ\rÆ®­µP{§Òì´\u0014¡î"}],"users":[],"servers":[{"server_id":0,"sha256":"KRM0c5eHrFpuQ3yGvHZdBPpGednZCjFsMpQzHTtVvAM="}],"request_mid":"14339482604127316574","pass":1}
GiftService.receive_message_send_gifts: msg.pass = 1
GiftService.receive_message_send_gifts: pass = 1, error report missing
GiftService.process_messages: mailbox.read.length = 0